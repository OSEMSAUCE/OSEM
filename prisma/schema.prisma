generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// Projects
model ProjectTable {
    projectId                  String              @id @unique
    projectName                String
    url                        String?
    platformId                 String?
    platform                   String? // FK to OrganizationLocalTable
    projectNotes               String?
    createdAt                  DateTime?           @default(now())
    lastEditedAt               DateTime?           @default(now()) @updatedAt
    deleted                    Boolean?            @default(false)
    carbonRegistryType         CarbonRegistryType?
    carbonRegistry             CarbonRegistry?
    employmentClaim            Int?
    employmentClaimDescription String?
    projectDateEnd             DateTime?
    projectDateStart           DateTime?
    registryId                 String?

    crops             CropTable[]
    lands             LandTable[]
    plantings         PlantingTable[]
    sources           SourceTable[]
    stakeholders      StakeholderTable[]
    polys             PolyTable[]
    organizationLocal OrganizationLocalTable? @relation(fields: [platform], references: [organizationLocalName], onDelete: NoAction, onUpdate: NoAction)

    @@index([platformId])
}

// Lands
model LandTable {
    landId        String         @id
    landName      String
    projectId     String
    hectares      Decimal?
    gpsLat        Decimal?
    gpsLon        Decimal?
    landNotes     String?
    createdAt     DateTime?      @default(now())
    lastEditedAt  DateTime?      @default(now()) @updatedAt
    treatmentType TreatmentType?
    editedBy      String?
    deleted       Boolean?       @default(false)
    preparation   String?

    project  ProjectTable   @relation(fields: [projectId], references: [projectId], onDelete: NoAction, onUpdate: NoAction)
    sources  SourceTable[]
    polygons PolygonTable[]

    @@index([projectId])
    @@index([landName])
}

// Crops
model CropTable {
    cropId                String    @id
    cropName              String
    projectId             String?
    speciesLocalName      String?
    speciesId             String?
    seedInfo              String?
    cropStock             String?
    createdAt             DateTime? @default(now())
    lastEditedAt          DateTime? @default(now()) @updatedAt
    editedBy              String?
    deleted               Boolean?  @default(false)
    organizationLocalName String?
    cropNotes             String?

    species SpeciesTable[]
    project ProjectTable?  @relation(fields: [projectId], references: [projectId], onDelete: NoAction, onUpdate: NoAction)
    sources SourceTable[]

    @@unique([projectId, cropName])
    @@index([organizationLocalName])
    @@index([projectId])
}

// Plantings
model PlantingTable {
    plantingId   String     @id @unique
    planted      Int?
    projectId    String
    parentId     String
    parentType   ParentType
    allocated    Int?
    plantingDate DateTime?
    createdAt    DateTime?  @default(now())
    lastEditedAt DateTime?  @default(now()) @updatedAt
    deleted      Boolean?   @default(false)

    // Generic unitized activity fields
    units        Decimal?
    unitType     UnitType?
    pricePerUnit Decimal?
    currency     String?

    project ProjectTable  @relation(fields: [projectId], references: [projectId], onDelete: NoAction, onUpdate: NoAction)
    sources SourceTable[]

    @@index([projectId])
    @@index([parentId])
    @@index([parentType])
    @@index([parentId, parentType])
}

// Species
model SpeciesTable {
    speciesName    String    @id @unique
    commonName     String
    scientificName String?
    type           String?
    family         String?
    reference      String?
    createdAt      DateTime? @default(now())
    lastEditedAt   DateTime? @default(now()) @updatedAt
    editedBy       String?
    deleted        Boolean?  @default(false)

    crops CropTable[]
}

// Polygons (GeoJSON geometry storage)
model PolygonTable {
    polygonId    String    @id
    landId       String
    landName     String?
    geometry     String? // Full GeoJSON as JSON string
    coordinates  String? // Coordinates as JSON string
    type         String? // "Polygon" or "MultiPolygon"
    polygonNotes String?
    lastEditedAt DateTime? @default(now()) @updatedAt

    land LandTable? @relation(fields: [landId], references: [landId], onDelete: NoAction, onUpdate: NoAction)

    @@index([landId])
}

// Poly (additional metadata)
model PolyTable {
    polyId          String           @id @unique
    parentId        String
    parentType      ParentType
    projectId       String
    randomJson      String?
    survivalRate    Float?
    liabilityCause  String?
    ratePerTree     Float?
    motivation      String?
    restorationType RestorationType?
    reviews         String?
    createdAt       DateTime?        @default(now())
    lastEditedAt    DateTime?        @default(now()) @updatedAt
    editedBy        String?
    deleted         Boolean?         @default(false)

    project ProjectTable? @relation(fields: [projectId], references: [projectId])

    @@index([projectId])
    @@index([parentId])
    @@index([parentType])
    @@index([parentId, parentType])
}

// Stakeholders
model StakeholderTable {
    stakeholderId       String           @id
    organizationLocalId String
    parentId            String
    parentType          ParentType
    projectId           String?
    stakeholderType     StakeholderType?
    lastEditedAt        DateTime?        @default(now()) @updatedAt
    createdAt           DateTime?        @default(now())

    project           ProjectTable?           @relation(fields: [projectId], references: [projectId], onUpdate: NoAction)
    organizationLocal OrganizationLocalTable? @relation(fields: [organizationLocalId], references: [organizationLocalId], onUpdate: NoAction)

    @@index([organizationLocalId])
}

// Sources
model SourceTable {
    sourceId          String          @id
    url               String
    urlType           UrlType?
    parentId          String?
    parentType        ParentType?
    projectId         String?
    disclosureType    DisclosureType?
    sourceDescription String?
    sourceCredit      String?
    lastEditedAt      DateTime?       @default(now()) @updatedAt
    createdAt         DateTime?       @default(now())

    projects           ProjectTable[]
    lands              LandTable[]
    crops              CropTable[]
    organizationLocals OrganizationLocalTable[]
    plantings          PlantingTable[]

    @@index([parentId])
    @@index([parentType])
    @@index([parentId, parentType])
}

// Raw scraped organization names - UNIQUE by exact spelling
model OrganizationLocalTable {
    organizationLocalName String    @unique
    organizationLocalId   String    @id
    organizationMasterId  String?
    contactName           String?
    contactEmail          String?
    contactPhone          String?
    address               String?
    polyId                String?
    website               String?
    capacityPerYear       Int?
    organizationNotes     String?
    createdAt             DateTime? @default(now())
    lastEditedAt          DateTime? @default(now()) @updatedAt
    editedBy              String?
    deleted               Boolean?  @default(false)
    gpsLat                Float?
    gpsLon                Float?

    sources        SourceTable[]
    stakeholders   StakeholderTable[]
    projectsHosted ProjectTable[]
    officialOrg    OrganizationMasterTable? @relation(fields: [organizationMasterId], references: [organizationMasterId])

    @@index([organizationLocalId])
}

// Validated canonical organizations
model OrganizationMasterTable {
    organizationMasterId   String    @id
    organizationMasterName String    @unique
    officialWebsite        String?
    createdAt              DateTime? @default(now())
    lastEditedAt           DateTime? @default(now()) @updatedAt
    editedBy               String?

    rawVariants OrganizationLocalTable[]
}

// Enums
enum ParentType {
    projectTable
    landTable
    cropTable
    plantingTable
    organizationTable
    sourceTable
    stakeholderTable
}

enum GeometryType {
    Polygon
    MultiPolygon
    MultiLineString
    LineString
    Point
    Feature
    FeatureCollection
    GeometryCollection
}

enum UnitType {
    cCO2e
    hectare
    acre
    tree
    credits
    project
    land
}

enum TreatmentType {
    ARR
    improved_forest_management
    avoided_deforestation
    forest_conservation
    regenerative_agriculture
    improved_agricultural_practices
    cover_cropping
    restoration
    agroforestry
}

enum UrlType {
    webpage
    api
    image
    video
    document
    review
    other
}

enum StakeholderType {
    developer
    nursery
    marketplace
    NGO
    research
    supplier
    producer
}

enum DisclosureType {
    publicDB
    company
    NGO
    marketplace
    disclosure
    research
}

enum CarbonRegistryType {
    ARR
    AD
    IFM
}

enum CarbonRegistry {
    Verra
    Gold_Standard
    Climate_Action_Reserve
    American_Carbon_Registry
    Plan_Vivo
    Social_Carbon
}

enum RestorationType {
    manual_planting
    drone_seeding
    mechanical_planting
    aerial_seeding
    natural_regeneration
    conservation
    improved_forest_management
    avoided_deforestation
    magrove_regeneration
    agroforestry
}
